{"ast":null,"code":"function _typeof(o) {\n  \"@babel/helpers - typeof\";\n\n  return _typeof = \"function\" == typeof Symbol && \"symbol\" == typeof Symbol.iterator ? function (o) {\n    return typeof o;\n  } : function (o) {\n    return o && \"function\" == typeof Symbol && o.constructor === Symbol && o !== Symbol.prototype ? \"symbol\" : typeof o;\n  }, _typeof(o);\n}\nfunction _slicedToArray(r, e) {\n  return _arrayWithHoles(r) || _iterableToArrayLimit(r, e) || _unsupportedIterableToArray(r, e) || _nonIterableRest();\n}\nfunction _nonIterableRest() {\n  throw new TypeError(\"Invalid attempt to destructure non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.\");\n}\nfunction _unsupportedIterableToArray(r, a) {\n  if (r) {\n    if (\"string\" == typeof r) return _arrayLikeToArray(r, a);\n    var t = {}.toString.call(r).slice(8, -1);\n    return \"Object\" === t && r.constructor && (t = r.constructor.name), \"Map\" === t || \"Set\" === t ? Array.from(r) : \"Arguments\" === t || /^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t) ? _arrayLikeToArray(r, a) : void 0;\n  }\n}\nfunction _arrayLikeToArray(r, a) {\n  (null == a || a > r.length) && (a = r.length);\n  for (var e = 0, n = Array(a); e < a; e++) n[e] = r[e];\n  return n;\n}\nfunction _iterableToArrayLimit(r, l) {\n  var t = null == r ? null : \"undefined\" != typeof Symbol && r[Symbol.iterator] || r[\"@@iterator\"];\n  if (null != t) {\n    var e,\n      n,\n      i,\n      u,\n      a = [],\n      f = !0,\n      o = !1;\n    try {\n      if (i = (t = t.call(r)).next, 0 === l) {\n        if (Object(t) !== t) return;\n        f = !1;\n      } else for (; !(f = (e = i.call(t)).done) && (a.push(e.value), a.length !== l); f = !0);\n    } catch (r) {\n      o = !0, n = r;\n    } finally {\n      try {\n        if (!f && null != t[\"return\"] && (u = t[\"return\"](), Object(u) !== u)) return;\n      } finally {\n        if (o) throw n;\n      }\n    }\n    return a;\n  }\n}\nfunction _arrayWithHoles(r) {\n  if (Array.isArray(r)) return r;\n}\nfunction _classCallCheck(a, n) {\n  if (!(a instanceof n)) throw new TypeError(\"Cannot call a class as a function\");\n}\nfunction _defineProperties(e, r) {\n  for (var t = 0; t < r.length; t++) {\n    var o = r[t];\n    o.enumerable = o.enumerable || !1, o.configurable = !0, \"value\" in o && (o.writable = !0), Object.defineProperty(e, _toPropertyKey(o.key), o);\n  }\n}\nfunction _createClass(e, r, t) {\n  return r && _defineProperties(e.prototype, r), t && _defineProperties(e, t), Object.defineProperty(e, \"prototype\", {\n    writable: !1\n  }), e;\n}\nfunction _toPropertyKey(t) {\n  var i = _toPrimitive(t, \"string\");\n  return \"symbol\" == _typeof(i) ? i : i + \"\";\n}\nfunction _toPrimitive(t, r) {\n  if (\"object\" != _typeof(t) || !t) return t;\n  var e = t[Symbol.toPrimitive];\n  if (void 0 !== e) {\n    var i = e.call(t, r || \"default\");\n    if (\"object\" != _typeof(i)) return i;\n    throw new TypeError(\"@@toPrimitive must return a primitive value.\");\n  }\n  return (\"string\" === r ? String : Number)(t);\n}\nimport { DirectUpload } from \"@rails/activestorage\";\nexport var Uploader = /*#__PURE__*/function () {\n  function Uploader(modal, uploadItem, options) {\n    _classCallCheck(this, Uploader);\n    this.modal = modal;\n    this.uploadItem = uploadItem;\n    this.progressBar = uploadItem.querySelector(\".progress-bar\");\n    this.validationSent = false;\n    this.fileTooBig = false;\n    if (modal.options.maxFileSize && options.file.size > modal.options.maxFileSize) {\n      this.fileTooBig = true;\n      this.showError([modal.locales.file_size_too_large]);\n    } else {\n      this.upload = new DirectUpload(options.file, options.url, this);\n    }\n  }\n  return _createClass(Uploader, [{\n    key: \"showError\",\n    value: function showError(errors) {\n      this.progressBar.classList.add(\"filled\");\n      this.progressBar.innerHTML = this.modal.locales.validation_error;\n      this.uploadItem.dataset.state = \"error\";\n      var errorList = this.uploadItem.querySelector(\".upload-errors\");\n      errors.forEach(function (error) {\n        var errorItem = document.createElement(\"li\");\n        errorItem.classList.add(\"form-error\", \"is-visible\");\n        errorItem.innerHTML = error;\n        errorList.appendChild(errorItem);\n      });\n    }\n  }, {\n    key: \"validate\",\n    value: function validate(blobId) {\n      var _this = this;\n      var callback = function callback(data) {\n        var errors = [];\n        for (var _i = 0, _Object$entries = Object.entries(data); _i < _Object$entries.length; _i++) {\n          var _Object$entries$_i = _slicedToArray(_Object$entries[_i], 2),\n            value = _Object$entries$_i[1];\n          errors = errors.concat(value);\n        }\n        _this.progressBar.style.justifyContent = \"center\";\n        if (errors.length === 0) {\n          _this.progressBar.innerHTML = _this.modal.locales.uploaded;\n          _this.uploadItem.dataset.state = \"validated\";\n        } else {\n          _this.showError(errors);\n        }\n        _this.progressBar.classList.add(\"filled\");\n      };\n      if (!this.validationSent) {\n        var property = this.modal.options.addAttribute;\n        if (this.modal.options.titled) {\n          property = \"file\";\n        }\n        var params = new URLSearchParams({\n          resourceClass: this.modal.options.resourceClass,\n          property: property,\n          blob: blobId,\n          formClass: this.modal.options.formObjectClass\n        });\n        fetch(\"/upload_validations?\".concat(params.toString()), {\n          method: \"POST\",\n          headers: {\n            \"Content-Type\": \"application/json\",\n            \"X-CSRF-Token\": $(\"meta[name=csrf-token]\").attr(\"content\")\n          }\n        }).then(function (response) {\n          return response.json();\n        }).then(function (data) {\n          callback(data);\n        });\n        this.validationSent = true;\n      }\n    }\n  }, {\n    key: \"directUploadWillStoreFileWithXHR\",\n    value: function directUploadWillStoreFileWithXHR(request) {\n      var _this2 = this;\n      request.upload.addEventListener(\"progress\", function (event) {\n        var progress = Math.floor(event.loaded / event.total * 100);\n        var width = \"15%\";\n        if (progress > 15) {\n          width = \"\".concat(progress, \"%\");\n        }\n        _this2.progressBar.style.width = width;\n        if (progress === 100) {\n          _this2.progressBar.innerHTML = _this2.modal.locales.validating;\n          return;\n        }\n        _this2.progressBar.innerHTML = \"\".concat(progress, \"%\");\n      });\n    }\n  }]);\n}();","map":{"version":3,"names":["DirectUpload","Uploader","modal","uploadItem","options","_classCallCheck","progressBar","querySelector","validationSent","fileTooBig","maxFileSize","file","size","showError","locales","file_size_too_large","upload","url","_createClass","key","value","errors","classList","add","innerHTML","validation_error","dataset","state","errorList","forEach","error","errorItem","document","createElement","appendChild","validate","blobId","_this","callback","data","_i","_Object$entries","Object","entries","length","_Object$entries$_i","_slicedToArray","concat","style","justifyContent","uploaded","property","addAttribute","titled","params","URLSearchParams","resourceClass","blob","formClass","formObjectClass","fetch","toString","method","headers","$","attr","then","response","json","directUploadWillStoreFileWithXHR","request","_this2","addEventListener","event","progress","Math","floor","loaded","total","width","validating"],"sources":["/home/daniele/decidim_idra/app/packs/src/decidim/direct_uploads/uploader.js"],"sourcesContent":["import { DirectUpload } from \"@rails/activestorage\";\n\nexport class Uploader {\n  constructor(modal, uploadItem, options) {\n    this.modal = modal;\n    this.uploadItem = uploadItem;\n    this.progressBar = uploadItem.querySelector(\".progress-bar\");\n    this.validationSent = false;\n    this.fileTooBig = false;\n    if (modal.options.maxFileSize && options.file.size > modal.options.maxFileSize) {\n      this.fileTooBig = true;\n      this.showError([modal.locales.file_size_too_large]);\n    } else {\n      this.upload = new DirectUpload(options.file, options.url, this);\n    }\n  }\n\n  showError(errors) {\n    this.progressBar.classList.add(\"filled\");\n    this.progressBar.innerHTML = this.modal.locales.validation_error;\n    this.uploadItem.dataset.state = \"error\";\n    const errorList = this.uploadItem.querySelector(\".upload-errors\");\n    errors.forEach((error) => {\n      const errorItem = document.createElement(\"li\");\n      errorItem.classList.add(\"form-error\", \"is-visible\");\n      errorItem.innerHTML = error;\n      errorList.appendChild(errorItem);\n    })\n  }\n\n  validate(blobId) {\n    const callback = (data) => {\n      let errors = []\n      for (const [, value] of Object.entries(data)) {\n        errors = errors.concat(value);\n      }\n\n      this.progressBar.style.justifyContent = \"center\";\n      if (errors.length === 0) {\n        this.progressBar.innerHTML = this.modal.locales.uploaded;\n        this.uploadItem.dataset.state = \"validated\";\n      } else {\n        this.showError(errors);\n      }\n      this.progressBar.classList.add(\"filled\");\n    }\n\n    if (!this.validationSent) {\n      let property = this.modal.options.addAttribute;\n      if (this.modal.options.titled) {\n        property = \"file\"\n      }\n      const params = new URLSearchParams({\n        resourceClass: this.modal.options.resourceClass,\n        property: property,\n        blob: blobId,\n        formClass: this.modal.options.formObjectClass\n      });\n\n      fetch(`/upload_validations?${params.toString()}`, {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n          \"X-CSRF-Token\": $(\"meta[name=csrf-token]\").attr(\"content\")\n        }\n      }).then((response) => response.json()).then((data) => {\n        callback(data);\n      });\n      this.validationSent = true;\n    }\n  }\n\n  directUploadWillStoreFileWithXHR(request) {\n    request.upload.addEventListener(\"progress\", (event) => {\n      const progress = Math.floor(event.loaded / event.total * 100);\n      let width = \"15%\";\n      if (progress > 15) {\n        width = `${progress}%`;\n      }\n      this.progressBar.style.width = width;\n\n      if (progress === 100) {\n        this.progressBar.innerHTML = this.modal.locales.validating;\n        return;\n      }\n      this.progressBar.innerHTML = `${progress}%`;\n    });\n  }\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,SAASA,YAAY,QAAQ,sBAAsB;AAEnD,WAAaC,QAAQ;EACnB,SAAAA,SAAYC,KAAK,EAAEC,UAAU,EAAEC,OAAO,EAAE;IAAAC,eAAA,OAAAJ,QAAA;IACtC,IAAI,CAACC,KAAK,GAAGA,KAAK;IAClB,IAAI,CAACC,UAAU,GAAGA,UAAU;IAC5B,IAAI,CAACG,WAAW,GAAGH,UAAU,CAACI,aAAa,CAAC,eAAe,CAAC;IAC5D,IAAI,CAACC,cAAc,GAAG,KAAK;IAC3B,IAAI,CAACC,UAAU,GAAG,KAAK;IACvB,IAAIP,KAAK,CAACE,OAAO,CAACM,WAAW,IAAIN,OAAO,CAACO,IAAI,CAACC,IAAI,GAAGV,KAAK,CAACE,OAAO,CAACM,WAAW,EAAE;MAC9E,IAAI,CAACD,UAAU,GAAG,IAAI;MACtB,IAAI,CAACI,SAAS,CAAC,CAACX,KAAK,CAACY,OAAO,CAACC,mBAAmB,CAAC,CAAC;IACrD,CAAC,MAAM;MACL,IAAI,CAACC,MAAM,GAAG,IAAIhB,YAAY,CAACI,OAAO,CAACO,IAAI,EAAEP,OAAO,CAACa,GAAG,EAAE,IAAI,CAAC;IACjE;EACF;EAAC,OAAAC,YAAA,CAAAjB,QAAA;IAAAkB,GAAA;IAAAC,KAAA,EAED,SAAAP,UAAUQ,MAAM,EAAE;MAChB,IAAI,CAACf,WAAW,CAACgB,SAAS,CAACC,GAAG,CAAC,QAAQ,CAAC;MACxC,IAAI,CAACjB,WAAW,CAACkB,SAAS,GAAG,IAAI,CAACtB,KAAK,CAACY,OAAO,CAACW,gBAAgB;MAChE,IAAI,CAACtB,UAAU,CAACuB,OAAO,CAACC,KAAK,GAAG,OAAO;MACvC,IAAMC,SAAS,GAAG,IAAI,CAACzB,UAAU,CAACI,aAAa,CAAC,gBAAgB,CAAC;MACjEc,MAAM,CAACQ,OAAO,CAAC,UAACC,KAAK,EAAK;QACxB,IAAMC,SAAS,GAAGC,QAAQ,CAACC,aAAa,CAAC,IAAI,CAAC;QAC9CF,SAAS,CAACT,SAAS,CAACC,GAAG,CAAC,YAAY,EAAE,YAAY,CAAC;QACnDQ,SAAS,CAACP,SAAS,GAAGM,KAAK;QAC3BF,SAAS,CAACM,WAAW,CAACH,SAAS,CAAC;MAClC,CAAC,CAAC;IACJ;EAAC;IAAAZ,GAAA;IAAAC,KAAA,EAED,SAAAe,SAASC,MAAM,EAAE;MAAA,IAAAC,KAAA;MACf,IAAMC,QAAQ,GAAG,SAAXA,QAAQA,CAAIC,IAAI,EAAK;QACzB,IAAIlB,MAAM,GAAG,EAAE;QACf,SAAAmB,EAAA,MAAAC,eAAA,GAAwBC,MAAM,CAACC,OAAO,CAACJ,IAAI,CAAC,EAAAC,EAAA,GAAAC,eAAA,CAAAG,MAAA,EAAAJ,EAAA,IAAE;UAAzC,IAAAK,kBAAA,GAAAC,cAAA,CAAAL,eAAA,CAAAD,EAAA;YAASpB,KAAK,GAAAyB,kBAAA;UACjBxB,MAAM,GAAGA,MAAM,CAAC0B,MAAM,CAAC3B,KAAK,CAAC;QAC/B;QAEAiB,KAAI,CAAC/B,WAAW,CAAC0C,KAAK,CAACC,cAAc,GAAG,QAAQ;QAChD,IAAI5B,MAAM,CAACuB,MAAM,KAAK,CAAC,EAAE;UACvBP,KAAI,CAAC/B,WAAW,CAACkB,SAAS,GAAGa,KAAI,CAACnC,KAAK,CAACY,OAAO,CAACoC,QAAQ;UACxDb,KAAI,CAAClC,UAAU,CAACuB,OAAO,CAACC,KAAK,GAAG,WAAW;QAC7C,CAAC,MAAM;UACLU,KAAI,CAACxB,SAAS,CAACQ,MAAM,CAAC;QACxB;QACAgB,KAAI,CAAC/B,WAAW,CAACgB,SAAS,CAACC,GAAG,CAAC,QAAQ,CAAC;MAC1C,CAAC;MAED,IAAI,CAAC,IAAI,CAACf,cAAc,EAAE;QACxB,IAAI2C,QAAQ,GAAG,IAAI,CAACjD,KAAK,CAACE,OAAO,CAACgD,YAAY;QAC9C,IAAI,IAAI,CAAClD,KAAK,CAACE,OAAO,CAACiD,MAAM,EAAE;UAC7BF,QAAQ,GAAG,MAAM;QACnB;QACA,IAAMG,MAAM,GAAG,IAAIC,eAAe,CAAC;UACjCC,aAAa,EAAE,IAAI,CAACtD,KAAK,CAACE,OAAO,CAACoD,aAAa;UAC/CL,QAAQ,EAAEA,QAAQ;UAClBM,IAAI,EAAErB,MAAM;UACZsB,SAAS,EAAE,IAAI,CAACxD,KAAK,CAACE,OAAO,CAACuD;QAChC,CAAC,CAAC;QAEFC,KAAK,wBAAAb,MAAA,CAAwBO,MAAM,CAACO,QAAQ,CAAC,CAAC,GAAI;UAChDC,MAAM,EAAE,MAAM;UACdC,OAAO,EAAE;YACP,cAAc,EAAE,kBAAkB;YAClC,cAAc,EAAEC,CAAC,CAAC,uBAAuB,CAAC,CAACC,IAAI,CAAC,SAAS;UAC3D;QACF,CAAC,CAAC,CAACC,IAAI,CAAC,UAACC,QAAQ;UAAA,OAAKA,QAAQ,CAACC,IAAI,CAAC,CAAC;QAAA,EAAC,CAACF,IAAI,CAAC,UAAC3B,IAAI,EAAK;UACpDD,QAAQ,CAACC,IAAI,CAAC;QAChB,CAAC,CAAC;QACF,IAAI,CAAC/B,cAAc,GAAG,IAAI;MAC5B;IACF;EAAC;IAAAW,GAAA;IAAAC,KAAA,EAED,SAAAiD,iCAAiCC,OAAO,EAAE;MAAA,IAAAC,MAAA;MACxCD,OAAO,CAACtD,MAAM,CAACwD,gBAAgB,CAAC,UAAU,EAAE,UAACC,KAAK,EAAK;QACrD,IAAMC,QAAQ,GAAGC,IAAI,CAACC,KAAK,CAACH,KAAK,CAACI,MAAM,GAAGJ,KAAK,CAACK,KAAK,GAAG,GAAG,CAAC;QAC7D,IAAIC,KAAK,GAAG,KAAK;QACjB,IAAIL,QAAQ,GAAG,EAAE,EAAE;UACjBK,KAAK,MAAAhC,MAAA,CAAM2B,QAAQ,MAAG;QACxB;QACAH,MAAI,CAACjE,WAAW,CAAC0C,KAAK,CAAC+B,KAAK,GAAGA,KAAK;QAEpC,IAAIL,QAAQ,KAAK,GAAG,EAAE;UACpBH,MAAI,CAACjE,WAAW,CAACkB,SAAS,GAAG+C,MAAI,CAACrE,KAAK,CAACY,OAAO,CAACkE,UAAU;UAC1D;QACF;QACAT,MAAI,CAACjE,WAAW,CAACkB,SAAS,MAAAuB,MAAA,CAAM2B,QAAQ,MAAG;MAC7C,CAAC,CAAC;IACJ;EAAC;AAAA","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}