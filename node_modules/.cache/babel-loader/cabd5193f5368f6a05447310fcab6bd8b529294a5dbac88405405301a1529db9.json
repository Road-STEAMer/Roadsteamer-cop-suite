{"ast":null,"code":"function _typeof(obj) {\n  \"@babel/helpers - typeof\";\n\n  return _typeof = \"function\" == typeof Symbol && \"symbol\" == typeof Symbol.iterator ? function (obj) {\n    return typeof obj;\n  } : function (obj) {\n    return obj && \"function\" == typeof Symbol && obj.constructor === Symbol && obj !== Symbol.prototype ? \"symbol\" : typeof obj;\n  }, _typeof(obj);\n}\nfunction _classCallCheck(instance, Constructor) {\n  if (!(instance instanceof Constructor)) {\n    throw new TypeError(\"Cannot call a class as a function\");\n  }\n}\nfunction _defineProperties(target, props) {\n  for (var i = 0; i < props.length; i++) {\n    var descriptor = props[i];\n    descriptor.enumerable = descriptor.enumerable || false;\n    descriptor.configurable = true;\n    if (\"value\" in descriptor) descriptor.writable = true;\n    Object.defineProperty(target, _toPropertyKey(descriptor.key), descriptor);\n  }\n}\nfunction _createClass(Constructor, protoProps, staticProps) {\n  if (protoProps) _defineProperties(Constructor.prototype, protoProps);\n  if (staticProps) _defineProperties(Constructor, staticProps);\n  Object.defineProperty(Constructor, \"prototype\", {\n    writable: false\n  });\n  return Constructor;\n}\nfunction _toPropertyKey(arg) {\n  var key = _toPrimitive(arg, \"string\");\n  return _typeof(key) === \"symbol\" ? key : String(key);\n}\nfunction _toPrimitive(input, hint) {\n  if (_typeof(input) !== \"object\" || input === null) return input;\n  var prim = input[Symbol.toPrimitive];\n  if (prim !== undefined) {\n    var res = prim.call(input, hint || \"default\");\n    if (_typeof(res) !== \"object\") return res;\n    throw new TypeError(\"@@toPrimitive must return a primitive value.\");\n  }\n  return (hint === \"string\" ? String : Number)(input);\n}\nfunction _get() {\n  if (typeof Reflect !== \"undefined\" && Reflect.get) {\n    _get = Reflect.get.bind();\n  } else {\n    _get = function _get(target, property, receiver) {\n      var base = _superPropBase(target, property);\n      if (!base) return;\n      var desc = Object.getOwnPropertyDescriptor(base, property);\n      if (desc.get) {\n        return desc.get.call(arguments.length < 3 ? target : receiver);\n      }\n      return desc.value;\n    };\n  }\n  return _get.apply(this, arguments);\n}\nfunction _superPropBase(object, property) {\n  while (!Object.prototype.hasOwnProperty.call(object, property)) {\n    object = _getPrototypeOf(object);\n    if (object === null) break;\n  }\n  return object;\n}\nfunction _inherits(subClass, superClass) {\n  if (typeof superClass !== \"function\" && superClass !== null) {\n    throw new TypeError(\"Super expression must either be null or a function\");\n  }\n  subClass.prototype = Object.create(superClass && superClass.prototype, {\n    constructor: {\n      value: subClass,\n      writable: true,\n      configurable: true\n    }\n  });\n  Object.defineProperty(subClass, \"prototype\", {\n    writable: false\n  });\n  if (superClass) _setPrototypeOf(subClass, superClass);\n}\nfunction _setPrototypeOf(o, p) {\n  _setPrototypeOf = Object.setPrototypeOf ? Object.setPrototypeOf.bind() : function _setPrototypeOf(o, p) {\n    o.__proto__ = p;\n    return o;\n  };\n  return _setPrototypeOf(o, p);\n}\nfunction _createSuper(Derived) {\n  var hasNativeReflectConstruct = _isNativeReflectConstruct();\n  return function _createSuperInternal() {\n    var Super = _getPrototypeOf(Derived),\n      result;\n    if (hasNativeReflectConstruct) {\n      var NewTarget = _getPrototypeOf(this).constructor;\n      result = Reflect.construct(Super, arguments, NewTarget);\n    } else {\n      result = Super.apply(this, arguments);\n    }\n    return _possibleConstructorReturn(this, result);\n  };\n}\nfunction _possibleConstructorReturn(self, call) {\n  if (call && (_typeof(call) === \"object\" || typeof call === \"function\")) {\n    return call;\n  } else if (call !== void 0) {\n    throw new TypeError(\"Derived constructors may only return object or undefined\");\n  }\n  return _assertThisInitialized(self);\n}\nfunction _assertThisInitialized(self) {\n  if (self === void 0) {\n    throw new ReferenceError(\"this hasn't been initialised - super() hasn't been called\");\n  }\n  return self;\n}\nfunction _isNativeReflectConstruct() {\n  if (typeof Reflect === \"undefined\" || !Reflect.construct) return false;\n  if (Reflect.construct.sham) return false;\n  if (typeof Proxy === \"function\") return true;\n  try {\n    Boolean.prototype.valueOf.call(Reflect.construct(Boolean, [], function () {}));\n    return true;\n  } catch (e) {\n    return false;\n  }\n}\nfunction _getPrototypeOf(o) {\n  _getPrototypeOf = Object.setPrototypeOf ? Object.getPrototypeOf.bind() : function _getPrototypeOf(o) {\n    return o.__proto__ || Object.getPrototypeOf(o);\n  };\n  return _getPrototypeOf(o);\n}\nimport * as L from \"leaflet\";\nimport Controller from \"src/decidim/decidim_awesome/awesome_map/controllers/controller\";\nimport ProposalsFetcher from \"src/decidim/decidim_awesome/awesome_map/api/proposals_fetcher\";\nvar ProposalIcon = L.DivIcon.SVGIcon.DecidimIcon.extend({\n  options: {\n    fillColor: \"#ef604d\",\n    fillOpacity: 0.8,\n    strokeWidth: 1,\n    strokeOpcacity: 1\n  }\n});\nvar ProposalsController = /*#__PURE__*/function (_Controller) {\n  _inherits(ProposalsController, _Controller);\n  var _super = _createSuper(ProposalsController);\n  function ProposalsController(awesomeMap, component) {\n    var _this;\n    _classCallCheck(this, ProposalsController);\n    _this = _super.call(this, awesomeMap, component);\n    _this.templateId = \"marker-proposal-popup\";\n    _this.amendments = {};\n    _this.setFetcher(ProposalsFetcher);\n    return _this;\n  }\n  _createClass(ProposalsController, [{\n    key: \"addControls\",\n    value: function addControls() {\n      _get(_getPrototypeOf(ProposalsController.prototype), \"addControls\", this).call(this);\n\n      // add control layer for amendments if any\n      if (this.awesomeMap.config.menu.amendments && this.component.amendments && !this.awesomeMap.layers.amendments) {\n        this.awesomeMap.layers.amendments = {\n          label: \"<span class=\\\"awesome_map-component\\\" id=\\\"awesome_map-amendments_\".concat(this.component.id, \"\\\" title=\\\"0\\\" data-layer=\\\"amendments\\\">\").concat(window.DecidimAwesome.texts.amendments, \"</span>\"),\n          group: new L.FeatureGroup.SubGroup(this.awesomeMap.cluster)\n        };\n        this.awesomeMap.controls.main.addOverlay(this.awesomeMap.layers.amendments.group, this.awesomeMap.layers.amendments.label);\n        this.awesomeMap.layers.amendments.group.addTo(this.awesomeMap.map);\n      }\n    }\n  }, {\n    key: \"loadNodes\",\n    value: function loadNodes() {\n      var _this2 = this;\n      // for each proposal, create a marker with an associated popup\n      this.fetcher.onNode = function (proposal) {\n        var marker = new L.Marker([proposal.coordinates.latitude, proposal.coordinates.longitude], {\n          icon: _this2.createIcon(ProposalIcon, _this2.awesomeMap.getCategory(proposal.category).color),\n          title: proposal.title.translation\n        });\n\n        // Check if it has amendments, add it to a list\n        // also assign parent's proposal categories to it\n        if (proposal.amendments && proposal.amendments.length) {\n          proposal.amendments.forEach(function (amendment) {\n            _this2.amendments[amendment.emendation.id] = proposal;\n          });\n        }\n\n        // console.log(\"new proposal\", proposal, \"marker\",  marker)\n        _this2.addMarker(marker, proposal);\n      };\n      this.fetcher.fetch();\n    }\n  }, {\n    key: \"_onFinished\",\n    value: function _onFinished() {\n      var _this3 = this;\n      var iterableAmendments = Object.entries(this.amendments);\n      this.awesomeMap.controls.updateStats(\"component_\".concat(this.component.id), this.allNodes.length - iterableAmendments.length);\n      this.awesomeMap.controls.updateStats(\"amendments_\".concat(this.component.id), iterableAmendments.length);\n\n      // Process all amendments\n      iterableAmendments.forEach(function (amendment) {\n        var marker = _this3.allNodes.find(function (node) {\n          return node.id === amendment[0];\n        });\n        var parent = amendment[1];\n        // console.log(\"marker\", marker, \"parent proposal\", parent)\n        // add marker to amendments layers and remove it from proposals\n        if (marker) {\n          try {\n            marker.marker.removeFrom(_this3.controls.group);\n          } catch (evt) {\n            console.error(\"error removeFrom marker\", marker, \"layer\", _this3.controls.group, evt);\n          }\n          if (_this3.awesomeMap.config.menu.amendments) {\n            marker.marker.addTo(_this3.awesomeMap.layers.amendments.group);\n            // mimic parent category (amendments doesn't have categories)\n            if (parent.category) {\n              marker.marker.setIcon(_this3.createIcon(ProposalIcon, _this3.awesomeMap.getCategory(parent.category).color));\n              _this3.addMarkerCategory(marker.marker, parent.category);\n            }\n          }\n        }\n      });\n      this.onFinished();\n    }\n  }]);\n  return ProposalsController;\n}(Controller);\nexport { ProposalsController as default };","map":{"version":3,"names":["L","Controller","ProposalsFetcher","ProposalIcon","DivIcon","SVGIcon","DecidimIcon","extend","options","fillColor","fillOpacity","strokeWidth","strokeOpcacity","ProposalsController","_Controller","_inherits","_super","_createSuper","awesomeMap","component","_this","_classCallCheck","call","templateId","amendments","setFetcher","_createClass","key","value","addControls","_get","_getPrototypeOf","prototype","config","menu","layers","label","concat","id","window","DecidimAwesome","texts","group","FeatureGroup","SubGroup","cluster","controls","main","addOverlay","addTo","map","loadNodes","_this2","fetcher","onNode","proposal","marker","Marker","coordinates","latitude","longitude","icon","createIcon","getCategory","category","color","title","translation","length","forEach","amendment","emendation","addMarker","fetch","_onFinished","_this3","iterableAmendments","Object","entries","updateStats","allNodes","find","node","parent","removeFrom","evt","console","error","setIcon","addMarkerCategory","onFinished","default"],"sources":["/home/daniele/.rbenv/versions/3.0.2/lib/ruby/gems/3.0.0/gems/decidim-decidim_awesome-0.10.2/app/packs/src/decidim/decidim_awesome/awesome_map/controllers/proposals_controller.js"],"sourcesContent":["import * as L from \"leaflet\";\nimport Controller from \"src/decidim/decidim_awesome/awesome_map/controllers/controller\";\nimport ProposalsFetcher from \"src/decidim/decidim_awesome/awesome_map/api/proposals_fetcher\";\n\nconst ProposalIcon = L.DivIcon.SVGIcon.DecidimIcon.extend({\n  options: {\n    fillColor: \"#ef604d\",\n    fillOpacity: 0.8,\n    strokeWidth: 1,\n    strokeOpcacity: 1\n  }\n});\nexport default class ProposalsController extends Controller {\n  constructor(awesomeMap, component) {\n    super(awesomeMap, component)\n    this.templateId = \"marker-proposal-popup\";\n    this.amendments = {};\n    this.setFetcher(ProposalsFetcher);\n  }\n\n  addControls() {\n    super.addControls();\n\n    // add control layer for amendments if any\n    if (this.awesomeMap.config.menu.amendments && this.component.amendments && !this.awesomeMap.layers.amendments) {\n      this.awesomeMap.layers.amendments = {\n        label: `<span class=\"awesome_map-component\" id=\"awesome_map-amendments_${this.component.id}\" title=\"0\" data-layer=\"amendments\">${window.DecidimAwesome.texts.amendments}</span>`,\n        group: new L.FeatureGroup.SubGroup(this.awesomeMap.cluster)\n      }\n      this.awesomeMap.controls.main.addOverlay(this.awesomeMap.layers.amendments.group, this.awesomeMap.layers.amendments.label);\n      this.awesomeMap.layers.amendments.group.addTo(this.awesomeMap.map);\n    }\n  }\n\n  loadNodes() {\n    // for each proposal, create a marker with an associated popup\n    this.fetcher.onNode = (proposal) => {\n      let marker = new L.Marker([proposal.coordinates.latitude, proposal.coordinates.longitude], {\n        icon: this.createIcon(ProposalIcon, this.awesomeMap.getCategory(proposal.category).color),\n        title: proposal.title.translation\n      });\n\n      // Check if it has amendments, add it to a list\n      // also assign parent's proposal categories to it\n      if (proposal.amendments && proposal.amendments.length) {\n        proposal.amendments.forEach((amendment) => {\n          this.amendments[amendment.emendation.id] = proposal;\n        });\n      }\n\n      // console.log(\"new proposal\", proposal, \"marker\",  marker)\n      this.addMarker(marker, proposal);\n    };\n\n    this.fetcher.fetch();\n  }\n\n  _onFinished() {\n    const iterableAmendments = Object.entries(this.amendments);\n    this.awesomeMap.controls.updateStats(`component_${this.component.id}`, this.allNodes.length - iterableAmendments.length);\n    this.awesomeMap.controls.updateStats(`amendments_${this.component.id}`, iterableAmendments.length);\n\n    // Process all amendments\n    iterableAmendments.forEach((amendment) => {\n      const marker = this.allNodes.find((node) => node.id === amendment[0]);\n      const parent = amendment[1];\n      // console.log(\"marker\", marker, \"parent proposal\", parent)\n      // add marker to amendments layers and remove it from proposals\n      if (marker) {\n        try { \n          marker.marker.removeFrom(this.controls.group) \n        } catch (evt) { \n          console.error(\"error removeFrom marker\", marker, \"layer\", this.controls.group,  evt);\n        }\n        if (this.awesomeMap.config.menu.amendments) {\n          marker.marker.addTo(this.awesomeMap.layers.amendments.group);\n          // mimic parent category (amendments doesn't have categories)\n          if (parent.category) {\n            marker.marker.setIcon(this.createIcon(ProposalIcon, this.awesomeMap.getCategory(parent.category).color));\n            this.addMarkerCategory(marker.marker, parent.category)\n          }\n        }\n      }\n    });\n\n    this.onFinished();\n  }\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}